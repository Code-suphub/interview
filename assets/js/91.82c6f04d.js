(window.webpackJsonp=window.webpackJsonp||[]).push([[91],{369:function(s,t,v){"use strict";v.r(t);var n=v(14),_=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"_4-21-用了-tcp-协议-数据一定不会丢吗"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_4-21-用了-tcp-协议-数据一定不会丢吗"}},[s._v("#")]),s._v(" 4.21 用了 TCP 协议，数据一定不会丢吗？")]),s._v(" "),t("blockquote",[t("p",[s._v("来源：公众号@小白 debug")]),s._v(" "),t("p",[s._v("原文地址："),t("a",{attrs:{href:"https://mp.weixin.qq.com/s/XNJoaVnYT1SxHsdNWeAaUw",target:"_blank",rel:"noopener noreferrer"}},[s._v("用了 TCP 协议，数据一定不会丢吗？"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("大家后，我是小林。")]),s._v(" "),t("p",[s._v("问大家一句：TCP 是一个可靠的传输协议，那它一定能保证数据不丢失吗？")]),s._v(" "),t("p",[s._v("这次，就跟大家探讨这个问题。")]),s._v(" "),t("h2",{attrs:{id:"数据包的发送流程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#数据包的发送流程"}},[s._v("#")]),s._v(" 数据包的发送流程")]),s._v(" "),t("p",[s._v("首先，我们两个手机的绿皮聊天软件客户端，要通信，中间会通过它们家服务器。大概长这样。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/1d0a1d60ca4f720423911cf8f25c4ac3.png",alt:"聊天软件三端通信"}})]),s._v(" "),t("p",[s._v("但为了"),t("strong",[s._v("简化模型")]),s._v("，我们把中间的服务器给省略掉，假设这是个端到端的通信。且为了保证消息的可靠性，我们盲猜它们之间用的是"),t("strong",[s._v("TCP 协议")]),s._v("进行通信。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/7e8bae365b8d27560aac1cd28f501156.png",alt:"聊天软件两端通信"}})]),s._v(" "),t("p",[s._v("为了发送数据包，两端首先会通过"),t("strong",[s._v("三次握手")]),s._v("，建立 TCP 连接。")]),s._v(" "),t("p",[s._v("一个数据包，从聊天框里发出，消息会从"),t("strong",[s._v("聊天软件")]),s._v("所在的"),t("strong",[s._v("用户空间")]),s._v("拷贝到"),t("strong",[s._v("内核空间")]),s._v("的"),t("strong",[s._v("发送缓冲区（send buffer）")]),s._v("，数据包就这样顺着"),t("strong",[s._v("传输层、网络层，进入到数据链路层，在这里数据包会经过流控（qdisc），再通过 RingBuffer 发到物理层的网卡")]),s._v("。数据就这样顺着"),t("strong",[s._v("网卡")]),s._v("发到了"),t("strong",[s._v("纷繁复杂")]),s._v("的网络世界里。这里头数据会经过 n 多个"),t("strong",[s._v("路由器和交换机")]),s._v("之间的跳转，最后到达"),t("strong",[s._v("目的机器的网卡")]),s._v("处。")]),s._v(" "),t("p",[s._v("此时目的机器的网卡会通知"),t("strong",[s._v("DMA")]),s._v("将数据包信息放到"),t("code",[s._v("RingBuffer")]),s._v("中，再触发一个"),t("strong",[s._v("硬中断")]),s._v("给"),t("code",[s._v("CPU")]),s._v("，"),t("code",[s._v("CPU")]),s._v("触发"),t("strong",[s._v("软中断")]),s._v("让"),t("code",[s._v("ksoftirqd")]),s._v("去"),t("code",[s._v("RingBuffer")]),s._v("收包，于是一个数据包就这样顺着"),t("strong",[s._v("物理层，数据链路层，网络层，传输层")]),s._v("，最后从内核空间拷贝到用户空间里的"),t("strong",[s._v("聊天软件")]),s._v("里。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/28e4d6b004530fbf75fe346d181baa81.png",alt:"网络发包收包全景图"}})]),s._v(" "),t("blockquote",[t("p",[s._v("画了那么大一张图，只水了 200 字做解释，我多少是有些心痛的。")])]),s._v(" "),t("p",[s._v("到这里，抛开一些细节，大家大概知道了一个数据包从"),t("strong",[s._v("发送到接收")]),s._v("的宏观过程。")]),s._v(" "),t("p",[s._v("可以看到，这上面全是密密麻麻的"),t("strong",[s._v("名词")]),s._v("。")]),s._v(" "),t("p",[s._v("整条链路下来，有不少地方可能会发生丢包。")]),s._v(" "),t("p",[s._v("但为了不让大家"),t("strong",[s._v("保持蹲姿太久")]),s._v("影响身体健康，我这边只重点讲下几个"),t("strong",[s._v("常见容易发生丢包的场景")]),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"建立连接时丢包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#建立连接时丢包"}},[s._v("#")]),s._v(" 建立连接时丢包")]),s._v(" "),t("p",[s._v("TCP 协议会通过"),t("strong",[s._v("三次握手")]),s._v("建立连接。大概长下面这样。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/923f5005edb536c0d07b096bbf2ca282.png",alt:"TCP 三次握手"}})]),s._v(" "),t("p",[s._v("在服务端，第一次握手之后，会先建立个"),t("strong",[s._v("半连接")]),s._v("，然后再发出第二次握手。这时候需要有个地方可以"),t("strong",[s._v("暂存")]),s._v("这些半连接。这个地方就叫"),t("strong",[s._v("半连接队列")]),s._v("。")]),s._v(" "),t("p",[s._v("如果之后第三次握手来了，半连接就会升级为全连接，然后暂存到另外一个叫"),t("strong",[s._v("全连接队列")]),s._v("的地方，坐等程序执行"),t("code",[s._v("accept()")]),s._v("方法将其取走使用。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/02a78bb83fe167324f26e8c910d7a7a2.png",alt:"半连接队列和全连接队列"}})]),s._v(" "),t("p",[s._v("是队列就有长度，有长度就有可能会满，如果它们"),t("strong",[s._v("满了")]),s._v("，那新来的包就会被"),t("strong",[s._v("丢弃")]),s._v("。")]),s._v(" "),t("p",[s._v("可以通过下面的方式查看是否存在这种丢包行为。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 全连接队列溢出次数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# netstat -s | grep overflowed")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4343")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("times")]),s._v(" the listen queue of a socket overflowed\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 半连接队列溢出次数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v('# netstat -s | grep -i "SYNs to LISTEN sockets dropped"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("109")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("times")]),s._v(" the listen queue of a socket overflowed \n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("从现象来看就是连接建立失败。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/591d630098b4fc5316a5005f1e94b844.png",alt:"图片"}})]),s._v(" "),t("h2",{attrs:{id:"流量控制丢包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#流量控制丢包"}},[s._v("#")]),s._v(" 流量控制丢包")]),s._v(" "),t("p",[s._v("应用层能发网络数据包的软件有那么多，如果所有数据不加控制一股脑冲入到网卡，网卡会吃不消，那怎么办？让数据按一定的规则排个队依次处理，也就是所谓的"),t("strong",[s._v("qdisc")]),s._v("("),t("strong",[s._v("Q")]),s._v("ueueing "),t("strong",[s._v("Disc")]),s._v("iplines，排队规则)，这也是我们常说的"),t("strong",[s._v("流量控制")]),s._v("机制。")]),s._v(" "),t("p",[s._v("排队，得先有个队列，而队列有个"),t("strong",[s._v("长度")]),s._v("。")]),s._v(" "),t("p",[s._v("我们可以通过下面的"),t("code",[s._v("ifconfig")]),s._v("命令查看到，里面涉及到的"),t("code",[s._v("txqueuelen")]),s._v("后面的数字"),t("code",[s._v("1000")]),s._v("，其实就是流控队列的长度。")]),s._v(" "),t("p",[s._v("当发送数据过快，流控队列长度"),t("code",[s._v("txqueuelen")]),s._v("又不够大时，就容易出现"),t("strong",[s._v("丢包")]),s._v("现象。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/6f2821018be08a2f27561155e8085de4.png",alt:"qdisc 丢包"}})]),s._v(" "),t("p",[s._v("可以通过下面的"),t("code",[s._v("ifconfig")]),s._v("命令，查看 TX 下的 dropped 字段，当它大于 0 时，则"),t("strong",[s._v("有可能")]),s._v("是发生了流控丢包。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ifconfig eth0")]),s._v("\neth0: "),t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("flags")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("416")]),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("3")]),s._v("<")]),s._v("UP,BROADCAST,RUNNING,MULTICAST"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("  mtu "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1500")]),s._v("\n        inet "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.21")]),s._v(".66.69  netmask "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("255.255")]),s._v(".240.0  broadcast "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.21")]),s._v(".79.255\n        inet6 fe80::216:3eff:fe25:269f  prefixlen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),s._v("  scopeid 0x2"),t("span",{pre:!0,attrs:{class:"token operator"}},[t("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("0")]),s._v("<")]),s._v("link"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n        ether 00:16:3e:25:26:9f  txqueuelen "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Ethernet"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        RX packets "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6962682")]),s._v("  bytes "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1119047079")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v(" GiB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        RX errors "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  dropped "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  overruns "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  frame "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        TX packets "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9688919")]),s._v("  bytes "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2072511384")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.9")]),s._v(" GiB"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n        TX errors "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  dropped "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" overruns "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  carrier "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  collisions "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br")])]),t("p",[s._v("当遇到这种情况时，我们可以尝试修改下流控队列的长度。比如像下面这样将 eth0 网卡的流控队列长度从 1000 提升为 1500.")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ifconfig eth0 txqueuelen 1500")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"网卡丢包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#网卡丢包"}},[s._v("#")]),s._v(" 网卡丢包")]),s._v(" "),t("p",[s._v("网卡和它的驱动导致丢包的场景也比较常见，原因很多，比如"),t("strong",[s._v("网线质量差，接触不良")]),s._v("。除此之外，我们来聊几个常见的场景。")]),s._v(" "),t("h3",{attrs:{id:"ringbuffer-过小导致丢包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ringbuffer-过小导致丢包"}},[s._v("#")]),s._v(" RingBuffer 过小导致丢包")]),s._v(" "),t("p",[s._v("上面提到，在接收数据时，会将数据暂存到"),t("code",[s._v("RingBuffer")]),s._v("接收缓冲区中，然后等着内核触发软中断慢慢收走。如果这个"),t("strong",[s._v("缓冲区过小")]),s._v("，而这时候发送的数据又过快，就有可能发生溢出，此时也会产生"),t("strong",[s._v("丢包")]),s._v("。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/8f3ed2d6c4e2e154849f1e661528fe89.png",alt:"RingBuffer 满了导致丢包"}})]),s._v(" "),t("p",[s._v("我们可以通过下面的命令去查看是否发生过这样的事情。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ifconfig")]),s._v("\neth0:  RX errors "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  dropped "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  overruns "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("  frame "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("查看上面的"),t("code",[s._v("overruns")]),s._v("指标，它记录了由于"),t("code",[s._v("RingBuffer")]),s._v("长度不足导致的溢出次数。")]),s._v(" "),t("p",[s._v("当然，用"),t("code",[s._v("ethtool")]),s._v("命令也能查看。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ethtool -S eth0|grep rx_queue_0_drops")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("但这里需要注意的是，因为一个网卡里是可以有"),t("strong",[s._v("多个 RingBuffer")]),s._v("的，所以上面的"),t("code",[s._v("rx_queue_0_drops")]),s._v("里的 0 代表的是"),t("strong",[s._v("第 0 个 RingBuffer")]),s._v("的丢包数，对于多队列的网卡，这个 0 还可以改成其他数字。但我的家庭条件不允许我看其他队列的丢包数，所以上面的命令对我来说是够用了。。。")]),s._v(" "),t("p",[s._v("当发现有这类型丢包的时候，可以通过下面的命令查看当前网卡的配置。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#ethtool -g eth0")]),s._v("\nRing parameters "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" eth0:\nPre-set maximums:\nRX:        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v("\nRX Mini:    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nRX Jumbo:    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nTX:        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v("\nCurrent hardware settings:\nRX:        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v("\nRX Mini:    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nRX Jumbo:    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\nTX:        "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1024")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("上面的输出内容，含义是"),t("strong",[s._v("RingBuffer 最大支持 4096 的长度，但现在实际只用了 1024。")])]),s._v(" "),t("p",[s._v("想要修改这个长度可以执行"),t("code",[s._v("ethtool -G eth1 rx 4096 tx 4096")]),s._v("将发送和接收 RingBuffer 的长度都改为 4096。")]),s._v(" "),t("p",[t("strong",[s._v("RingBuffer")]),s._v("增大之后，可以减少因为容量小而导致的丢包情况。")]),s._v(" "),t("h3",{attrs:{id:"网卡性能不足"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#网卡性能不足"}},[s._v("#")]),s._v(" 网卡性能不足")]),s._v(" "),t("p",[s._v("网卡作为硬件，"),t("strong",[s._v("传输速度是有上限的")]),s._v("。当网络传输速度过大，达到网卡上限时，就会发生丢包。这种情况一般常见于压测场景。")]),s._v(" "),t("p",[s._v("我们可以通过"),t("code",[s._v("ethtool")]),s._v("加网卡名，获得当前网卡支持的最大速度。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ethtool eth0")]),s._v("\nSettings "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" eth0:\n    Speed: 10000Mb/s\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("可以看到，我这边用的网卡能支持的最大传输速度"),t("strong",[s._v("speed=1000Mb/s")]),s._v("。")]),s._v(" "),t("p",[s._v("也就是俗称的千兆网卡，但注意这里的单位是"),t("strong",[s._v("Mb")]),s._v("，这里的"),t("strong",[s._v("b 是指 bit，而不是 Byte。1Byte=8bit")]),s._v("。所以 10000Mb/s 还要除以 8，也就是理论上网卡最大传输速度是"),t("code",[s._v("1000/8 = 125MB/s")]),s._v("。")]),s._v(" "),t("p",[s._v("我们可以通过"),t("code",[s._v("sar命令")]),s._v("从网络接口层面来分析数据包的收发情况。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sar -n DEV 1")]),s._v("\nLinux "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.10")]),s._v(".0-1127.19.1.el7.x86_64      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2022")]),s._v("年07月27日     _x86_64_    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" CPU"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\n08时35分39秒     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s    rxcmp/s   txcmp/s  rxmcst/s\n08时35分40秒      eth0      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6.06")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.04")]),s._v("      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.35")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("121682.33")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("其中 "),t("strong",[s._v("txkB/s 是指当前每秒发送的字节（byte）总数，rxkB/s 是指每秒接收的字节（byte）总数")]),s._v("。")]),s._v(" "),t("p",[s._v("当两者加起来的值约等于"),t("code",[s._v("12~13w字节")]),s._v("的时候，也就对应大概"),t("code",[s._v("125MB/s")]),s._v("的传输速度。此时达到网卡性能极限，就会开始丢包。")]),s._v(" "),t("p",[s._v("遇到这个问题，优先看下你的服务是不是真有这么大的"),t("strong",[s._v("真实流量")]),s._v("，如果是的话可以考虑下拆分服务，或者就忍痛充钱升级下配置吧。")]),s._v(" "),t("h2",{attrs:{id:"接收缓冲区丢包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#接收缓冲区丢包"}},[s._v("#")]),s._v(" 接收缓冲区丢包")]),s._v(" "),t("p",[s._v("我们一般使用"),t("code",[s._v("TCP socket")]),s._v("进行网络编程的时候，内核都会分配一个"),t("strong",[s._v("发送缓冲区")]),s._v("和一个"),t("strong",[s._v("接收缓冲区")]),s._v("。")]),s._v(" "),t("p",[s._v("当我们想要发一个数据包，会在代码里执行"),t("code",[s._v("send(msg)")]),s._v("，这时候数据包并不是一把梭直接就走网卡飞出去的。而是将数据拷贝到内核"),t("strong",[s._v("发送缓冲区")]),s._v("就完事"),t("strong",[s._v("返回")]),s._v("了，至于"),t("strong",[s._v("什么时候发数据，发多少数据")]),s._v("，这个后续由内核自己做决定。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/9cd22437777205662048c73cc5855add.png",alt:"tcp_sendmsg 逻辑"}})]),s._v(" "),t("p",[s._v("而"),t("strong",[s._v("接收缓冲区")]),s._v("作用也类似，从外部网络收到的数据包就暂存在这个地方，然后坐等用户空间的应用程序将数据包取走。")]),s._v(" "),t("p",[s._v("这两个缓冲区是有大小限制的，可以通过下面的命令去查看。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看接收缓冲区")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sysctl net.ipv4.tcp_rmem")]),s._v("\nnet.ipv4.tcp_rmem "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("87380")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6291456")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 查看发送缓冲区")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# sysctl net.ipv4.tcp_wmem")]),s._v("\nnet.ipv4.tcp_wmem "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4096")]),s._v("    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16384")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4194304")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("不管是接收缓冲区还是发送缓冲区，都能看到三个数值，分别对应缓冲区的"),t("strong",[s._v("最小值，默认值和最大值（min、default、max）。缓冲区会在 min 和 max 之间动态调整。")])]),s._v(" "),t("p",[t("strong",[s._v("那么问题来了，如果缓冲区设置过小会怎么样？")])]),s._v(" "),t("p",[s._v("对于"),t("strong",[s._v("发送缓冲区")]),s._v("，执行 send 的时候，如果是"),t("strong",[s._v("阻塞")]),s._v("调用，那就会等，等到缓冲区有空位可以发数据。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/7312e536393463dcf0d57aeb07f28ed5.gif",alt:"send 阻塞"}})]),s._v(" "),t("p",[s._v("如果是"),t("strong",[s._v("非阻塞")]),s._v("调用，就会"),t("strong",[s._v("立刻返回")]),s._v("一个 "),t("code",[s._v("EAGAIN")]),s._v(" 错误信息，意思是  "),t("code",[s._v("Try again")]),s._v("。让应用程序下次再重试。这种情况下一般不会发生丢包。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/f378a299ca60c490ee5437e1143916c8.gif",alt:"send 非阻塞"}})]),s._v(" "),t("p",[s._v("当接受缓冲区满了，事情就不一样了，它的 TCP 接收窗口会变为 0，也就是所谓的"),t("strong",[s._v("零窗口")]),s._v("，并且会通过数据包里的"),t("code",[s._v("win=0")]),s._v('，告诉发送端，"球球了，顶不住了，别发了"。一般这种情况下，发送端就该停止发消息了，但如果这时候确实还有数据发来，就会发生'),t("strong",[s._v("丢包")]),s._v("。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/2df66c2e1d9f1245813e8d1de7482e0c.png",alt:"recv_buffer 丢包"}})]),s._v(" "),t("p",[s._v("我们可以通过下面的命令里的"),t("code",[s._v("TCPRcvQDrop")]),s._v("查看到有没有发生过这种丢包现象。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /proc/net/netstat\nTcpExt: SyncookiesSent TCPRcvQDrop SyncookiesFailed\nTcpExt: "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("157")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60116")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("但是说个伤心的事情，我们一般也看不到这个"),t("code",[s._v("TCPRcvQDrop")]),s._v("，因为这个是"),t("code",[s._v("5.9版本")]),s._v("里引入的打点，而我们的服务器用的一般是"),t("code",[s._v("2.x~3.x")]),s._v("左右版本。你可以通过下面的命令查看下你用的是什么版本的 linux 内核。")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# cat /proc/version")]),s._v("\nLinux version "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.10")]),s._v(".0-1127.19.1.el7.x86_64\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("h2",{attrs:{id:"两端之间的网络丢包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#两端之间的网络丢包"}},[s._v("#")]),s._v(" 两端之间的网络丢包")]),s._v(" "),t("p",[s._v("前面提到的是两端机器内部的网络丢包，除此之外，两端之间那么长的一条链路都属于外部网络，这中间有各种路由器和交换机还有光缆啥的，丢包也是很经常发生的。")]),s._v(" "),t("p",[s._v("这些丢包行为发生在中间链路的某些个机器上，我们当然是没权限去登录这些机器。但我们可以通过一些命令观察整个链路的连通情况。")]),s._v(" "),t("h3",{attrs:{id:"ping-命令查看丢包"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ping-命令查看丢包"}},[s._v("#")]),s._v(" "),t("strong",[s._v("ping 命令查看丢包")])]),s._v(" "),t("p",[s._v("比如我们知道目的地的域名是 "),t("code",[s._v("baidu.com")]),s._v("。想知道你的机器到 baidu 服务器之间，有没有产生丢包行为。可以使用 ping 命令。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/56bdca9995c0c2a343b2b73b67933b78.png",alt:"ping 查看丢包"}})]),s._v(" "),t("p",[s._v("倒数第二行里有个"),t("code",[s._v("100% packet loss")]),s._v("，意思是丢包率 100%。")]),s._v(" "),t("p",[s._v("但这样其实你只能知道"),t("strong",[s._v("你的机器和目的机器之间有没有丢包。")])]),s._v(" "),t("p",[t("strong",[s._v("那如果你想知道你和目的机器之间的这条链路，哪个节点丢包了，有没有办法呢？")])]),s._v(" "),t("p",[s._v("有。")]),s._v(" "),t("h3",{attrs:{id:"mtr-命令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#mtr-命令"}},[s._v("#")]),s._v(" "),t("strong",[s._v("mtr 命令")])]),s._v(" "),t("p",[s._v("mtr 命令可以查看到你的机器和目的机器之间的每个节点的丢包情况。")]),s._v(" "),t("p",[s._v("像下面这样执行命令。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/4a2d8dbfb648bcced864fb653af9f036.png",alt:"mtr_icmp"}})]),s._v(" "),t("p",[s._v("其中 -r 是指 report，以报告的形式打印结果。")]),s._v(" "),t("p",[s._v("可以看到"),t("code",[s._v("Host")]),s._v("那一列，出现的都是链路中间每一跳的机器，"),t("code",[s._v("Loss")]),s._v("的那一列就是指这一跳对应的丢包率。")]),s._v(" "),t("p",[s._v("需要注意的是，中间有一些是 host 是"),t("code",[s._v("???")]),s._v("，那个是因为"),t("strong",[s._v("mtr 默认用的是 ICMP 包")]),s._v("，有些节点限制了"),t("strong",[s._v("ICMP 包")]),s._v("，导致不能正常展示。")]),s._v(" "),t("p",[s._v("我们可以在 mtr 命令里加个"),t("code",[s._v("-u")]),s._v("，也就是使用"),t("strong",[s._v("udp 包")]),s._v("，就能看到部分？??对应的 IP。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/0650adc524ab7d82028dc83cfc9961e1.png",alt:"mtr-udp"}})]),s._v(" "),t("p",[s._v("把"),t("strong",[s._v("ICMP 包和 UDP 包的结果")]),s._v("拼在一起看，就是"),t("strong",[s._v("比较完整")]),s._v("的链路图了。")]),s._v(" "),t("p",[s._v("还有个小细节，"),t("code",[s._v("Loss")]),s._v("那一列，我们在 icmp 的场景下，关注"),t("strong",[s._v("最后一行")]),s._v("，如果是 0%，那不管前面 loss 是 100% 还是 80% 都无所谓，那些都是"),t("strong",[s._v("节点限制")]),s._v("导致的"),t("strong",[s._v("虚报")]),s._v("。")]),s._v(" "),t("p",[s._v("但如果"),t("strong",[s._v("最后一行是 20%，再往前几行都是 20% 左右")]),s._v("，那说明丢包就是从最接近的那一行开始产生的，长时间是这样，那很可能这一跳出了点问题。如果是公司内网的话，你可以带着这条线索去找对应的网络同事。如果是外网的话，那耐心点等等吧，别人家的开发会比你更着急。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/7142a4e285024dc6aadea4255984c485.png",alt:"图片"}})]),s._v(" "),t("h2",{attrs:{id:"发生丢包了怎么办"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#发生丢包了怎么办"}},[s._v("#")]),s._v(" 发生丢包了怎么办")]),s._v(" "),t("p",[s._v("说了这么多。只是想告诉大家，"),t("strong",[s._v("丢包是很常见的，几乎不可避免的一件事情")]),s._v("。")]),s._v(" "),t("p",[s._v("但问题来了，发生丢包了怎么办？")]),s._v(" "),t("p",[s._v("这个好办，用"),t("strong",[s._v("TCP 协议")]),s._v("去做传输。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/b2225e071fec7cfb240aa295ed4037bf.png",alt:"TCP 是什么"}})]),s._v(" "),t("p",[s._v("建立了 TCP 连接的两端，发送端在发出数据后会等待接收端回复"),t("code",[s._v("ack包")]),s._v("，"),t("code",[s._v("ack包")]),s._v("的目的是为了告诉对方自己确实收到了数据，但如果中间链路发生了丢包，那发送端会迟迟收不到确认 ack，于是就会进行"),t("strong",[s._v("重传")]),s._v("。以此来保证每个数据包都确确实实到达了接收端。")]),s._v(" "),t("p",[s._v("假设现在网断了，我们还用聊天软件发消息，聊天软件会使用 TCP 不断尝试重传数据，"),t("strong",[s._v("如果重传期间网络恢复了")]),s._v("，那数据就能正常发过去。但如果多次重试直到超时都还是失败，这时候你将收获一个"),t("strong",[s._v("红色感叹号")]),s._v("。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/c1460d52efe7c5e4d80c2f7160d5b126.png",alt:"图片"}})]),s._v(" "),t("p",[s._v("这时候问题又来了。")]),s._v(" "),t("p",[s._v("假设"),t("strong",[s._v("某绿皮聊天软件用的就是 TCP 协议。")])]),s._v(" "),t("p",[s._v("在聊天的时候，发生丢包了，丢包了会"),t("strong",[s._v("重试")]),s._v("，重试失败了还会出现"),t("strong",[s._v("红色感叹号。")])]),s._v(" "),t("p",[s._v("于是乎，问题就变成了，"),t("strong",[s._v("用了 TCP 协议，就一定不会丢包吗？")])]),s._v(" "),t("h2",{attrs:{id:"用了-tcp-协议就一定不会丢包吗"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#用了-tcp-协议就一定不会丢包吗"}},[s._v("#")]),s._v(" 用了 TCP 协议就一定不会丢包吗")]),s._v(" "),t("p",[s._v("我们知道 TCP 位于"),t("strong",[s._v("传输层")]),s._v("，在它的上面还有各种"),t("strong",[s._v("应用层协议")]),s._v("，比如常见的 HTTP 或者各类 RPC 协议。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/c6794dd51c8780f12e4022fc964ebb0a.png",alt:"四层网络协议"}})]),s._v(" "),t("p",[s._v("TCP 保证的可靠性，是"),t("strong",[s._v("传输层的可靠性")]),s._v("。也就是说，"),t("strong",[s._v("TCP 只保证数据从 A 机器的传输层可靠地发到 B 机器的传输层。")])]),s._v(" "),t("p",[s._v("至于数据到了接收端的传输层之后，能不能保证到应用层，TCP 并不管。")]),s._v(" "),t("p",[s._v("假设现在，我们输入一条消息，从聊天框发出，走到"),t("strong",[s._v("传输层 TCP 协议的发送缓冲区")]),s._v("，不管中间有没有丢包，最后通过重传都保证发到了对方的"),t("strong",[s._v("传输层 TCP 接收缓冲区")]),s._v("，此时接收端回复了一个"),t("code",[s._v("ack")]),s._v("，发送端收到这个"),t("code",[s._v("ack")]),s._v("后就会将自己"),t("strong",[s._v("发送缓冲区")]),s._v("里的消息给扔掉。到这里 TCP 的任务就结束了。")]),s._v(" "),t("p",[s._v("TCP 任务是结束了，但聊天软件的任务没结束。")]),s._v(" "),t("p",[t("strong",[s._v("聊天软件还需要将数据从 TCP 的接收缓冲区里读出来，如果在读出来这一刻，手机由于内存不足或其他各种原因，导致软件崩溃闪退了。")])]),s._v(" "),t("p",[s._v("发送端以为自己发的消息已经发给对方了，但接收端却并没有收到这条消息。")]),s._v(" "),t("p",[s._v("于是乎，"),t("strong",[s._v("消息就丢了。")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/9286ab84bcaa74576bc11c8e9322fee9.png",alt:"使用 TCP 协议却发生丢包"}})]),s._v(" "),t("p",[t("strong",[s._v("虽然概率很小，但它就是发生了")]),s._v("。")]),s._v(" "),t("p",[s._v("合情合理，逻辑自洽。")]),s._v(" "),t("h2",{attrs:{id:"这类丢包问题怎么解决"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#这类丢包问题怎么解决"}},[s._v("#")]),s._v(" 这类丢包问题怎么解决？")]),s._v(" "),t("p",[s._v("故事到这里也到尾声了，感动之余，我们来"),t("strong",[s._v("聊点掏心窝子的话")]),s._v("。")]),s._v(" "),t("p",[t("strong",[s._v("其实前面说的都对，没有一句是假话")]),s._v("。")]),s._v(" "),t("p",[s._v("但某绿皮聊天软件这么成熟，怎么可能没考虑过这一点呢。")]),s._v(" "),t("p",[s._v("大家应该还记得我们文章开头提到过，"),t("strong",[s._v("为了简单")]),s._v("，就将服务器那一方给省略了，从三端通信变成了两端通信，所以才有了这个丢包问题。")]),s._v(" "),t("p",[t("strong",[s._v("现在我们重新将服务器加回来。")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://img-blog.csdnimg.cn/img_convert/d53659df39d64db4780d2816bd8314d1.png",alt:"聊天软件三端通信"}})]),s._v(" "),t("p",[s._v("大家有没有发现，有时候我们在手机里聊了一大堆内容，然后登录电脑版，它能将最近的聊天记录都同步到电脑版上。也就是说服务器"),t("strong",[s._v("可能")]),s._v("记录了我们最近发过什么数据，假设"),t("strong",[s._v("每条消息都有个 id")]),s._v("，服务器和聊天软件每次都拿"),t("strong",[s._v("最新消息的 id")]),s._v("进行对比，就能知道两端消息是否一致，就像"),t("strong",[s._v("对账")]),s._v("一样。")]),s._v(" "),t("p",[s._v("对于"),t("strong",[s._v("发送方")]),s._v("，只要定时跟服务端的内容对账一下，就知道哪条消息没发送成功，直接重发就好了。")]),s._v(" "),t("p",[s._v("如果"),t("strong",[s._v("接收方")]),s._v("的聊天软件崩溃了，重启后跟服务器稍微通信一下就知道少了哪条数据，同步上来就是了，所以也不存在上面提到的丢包情况。")]),s._v(" "),t("p",[s._v("可以看出，"),t("strong",[s._v("TCP 只保证传输层的消息可靠性，并不保证应用层的消息可靠性。如果我们还想保证应用层的消息可靠性，就需要应用层自己去实现逻辑做保证。")])]),s._v(" "),t("p",[s._v("那么问题叒来了，"),t("strong",[s._v("两端通信的时候也能对账，为什么还要引入第三端服务器？")])]),s._v(" "),t("p",[s._v("主要有三个原因。")]),s._v(" "),t("ul",[t("li",[s._v("第一，如果是两端通信，你聊天软件里有"),t("code",[s._v("1000个")]),s._v("好友，你就得建立"),t("code",[s._v("1000个")]),s._v("连接。但如果引入服务端，你只需要跟服务器建立"),t("code",[s._v("1个")]),s._v("连接就够了，"),t("strong",[s._v("聊天软件消耗的资源越少，手机就越省电")]),s._v("。")]),s._v(" "),t("li",[s._v("第二，就是"),t("strong",[s._v("安全问题")]),s._v("，如果还是两端通信，随便一个人找你对账一下，你就把聊天记录给同步过去了，这并不合适吧。如果对方别有用心，信息就泄露了。引入第三方服务端就可以很方便的做各种"),t("strong",[s._v("鉴权")]),s._v("校验。")]),s._v(" "),t("li",[s._v("第三，是"),t("strong",[s._v("软件版本问题")]),s._v("。软件装到用户手机之后，软件更不更新就是由用户说了算了。如果还是两端通信，且两端的"),t("strong",[s._v("软件版本跨度太大")]),s._v("，很容易产生各种兼容性问题，但引入第三端服务器，就可以强制部分过低版本升级，否则不能使用软件。但对于大部分兼容性问题，给服务端加兼容逻辑就好了，不需要强制用户更新软件。")])]),s._v(" "),t("p",[s._v("所以看到这里大家应该明白了，我把服务端去掉，并不单纯是"),t("strong",[s._v("为了简单")]),s._v("。")]),s._v(" "),t("h2",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("ul",[t("li",[s._v("数据从发送端到接收端，链路很长，任何一个地方都可能发生丢包，几乎可以说丢包不可避免。")]),s._v(" "),t("li",[s._v("平时没事也不用关注丢包，大部分时候 TCP 的重传机制保证了消息可靠性。")]),s._v(" "),t("li",[s._v("当你发现服务异常的时候，比如接口延时很高，总是失败的时候，可以用 ping 或者 mtr 命令看下是不是中间链路发生了丢包。")]),s._v(" "),t("li",[s._v("TCP 只保证传输层的消息可靠性，并不保证应用层的消息可靠性。如果我们还想保证应用层的消息可靠性，就需要应用层自己去实现逻辑做保证。")])]),s._v(" "),t("hr"),s._v(" "),t("p",[t("em",[t("strong",[s._v("哈喽，我是小林，就爱图解计算机基础，如果觉得文章对你有帮助，欢迎微信搜索「小林 coding」")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost3@main/%E5%85%B6%E4%BB%96/%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BB%8B%E7%BB%8D.png",alt:"img"}})])])}),[],!1,null,null,null);t.default=_.exports}}]);