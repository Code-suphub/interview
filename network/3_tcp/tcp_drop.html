<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4.21 用了 TCP 协议，数据一定不会丢吗？</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/interview/logo.png">
    <link rel="manifest" href="/interview/manifest.json">
    <link rel="apple-touch-icon" href="/interview/icon512_maskable.png">
    <link rel="mask-icon" href="/interview/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <script>
          var _hmt = _hmt || [];
          (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?2675818a983a3131404cee835018f016";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
          })();
        </script>
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/interview/assets/css/0.styles.e79fd175.css" as="style"><link rel="preload" href="/interview/assets/js/app.c813ac80.js" as="script"><link rel="preload" href="/interview/assets/js/2.181747c8.js" as="script"><link rel="preload" href="/interview/assets/js/1.1f95d45d.js" as="script"><link rel="preload" href="/interview/assets/js/91.82c6f04d.js" as="script"><link rel="prefetch" href="/interview/assets/js/10.046e31ac.js"><link rel="prefetch" href="/interview/assets/js/100.ec6186cc.js"><link rel="prefetch" href="/interview/assets/js/101.2b1ad60d.js"><link rel="prefetch" href="/interview/assets/js/102.760f489e.js"><link rel="prefetch" href="/interview/assets/js/103.0ef392e5.js"><link rel="prefetch" href="/interview/assets/js/104.7aad30e5.js"><link rel="prefetch" href="/interview/assets/js/105.fecbc6fd.js"><link rel="prefetch" href="/interview/assets/js/106.ef11b852.js"><link rel="prefetch" href="/interview/assets/js/107.d85766ce.js"><link rel="prefetch" href="/interview/assets/js/108.67f7d836.js"><link rel="prefetch" href="/interview/assets/js/109.159ffb3b.js"><link rel="prefetch" href="/interview/assets/js/11.6e1b1c97.js"><link rel="prefetch" href="/interview/assets/js/110.3583168a.js"><link rel="prefetch" href="/interview/assets/js/111.64423dee.js"><link rel="prefetch" href="/interview/assets/js/112.833d44d1.js"><link rel="prefetch" href="/interview/assets/js/113.0935cbc6.js"><link rel="prefetch" href="/interview/assets/js/114.fc92e5ba.js"><link rel="prefetch" href="/interview/assets/js/115.41aa9b56.js"><link rel="prefetch" href="/interview/assets/js/116.856e48c0.js"><link rel="prefetch" href="/interview/assets/js/117.5cc83dd3.js"><link rel="prefetch" href="/interview/assets/js/118.10d31e30.js"><link rel="prefetch" href="/interview/assets/js/119.ba9c0cca.js"><link rel="prefetch" href="/interview/assets/js/12.c84dfb3f.js"><link rel="prefetch" href="/interview/assets/js/120.1ebeedb3.js"><link rel="prefetch" href="/interview/assets/js/121.5df8b9e3.js"><link rel="prefetch" href="/interview/assets/js/122.5ff5ec2b.js"><link rel="prefetch" href="/interview/assets/js/123.cdd9b131.js"><link rel="prefetch" href="/interview/assets/js/124.531459af.js"><link rel="prefetch" href="/interview/assets/js/125.277fd06e.js"><link rel="prefetch" href="/interview/assets/js/126.c08db809.js"><link rel="prefetch" href="/interview/assets/js/127.5e88ed35.js"><link rel="prefetch" href="/interview/assets/js/128.89befc3e.js"><link rel="prefetch" href="/interview/assets/js/129.f5ef947c.js"><link rel="prefetch" href="/interview/assets/js/13.e0546597.js"><link rel="prefetch" href="/interview/assets/js/130.b6722abb.js"><link rel="prefetch" href="/interview/assets/js/131.d06f78ea.js"><link rel="prefetch" href="/interview/assets/js/132.3008455a.js"><link rel="prefetch" href="/interview/assets/js/133.61134fed.js"><link rel="prefetch" href="/interview/assets/js/134.d37b6a43.js"><link rel="prefetch" href="/interview/assets/js/135.1c1b1110.js"><link rel="prefetch" href="/interview/assets/js/136.1d9dc025.js"><link rel="prefetch" href="/interview/assets/js/137.fa43fd83.js"><link rel="prefetch" href="/interview/assets/js/138.283dad01.js"><link rel="prefetch" href="/interview/assets/js/139.549da325.js"><link rel="prefetch" href="/interview/assets/js/14.3f5cea37.js"><link rel="prefetch" href="/interview/assets/js/140.eb41452a.js"><link rel="prefetch" href="/interview/assets/js/141.154770fe.js"><link rel="prefetch" href="/interview/assets/js/142.d80f75cd.js"><link rel="prefetch" href="/interview/assets/js/143.1318ed05.js"><link rel="prefetch" href="/interview/assets/js/144.cc5b1a7b.js"><link rel="prefetch" href="/interview/assets/js/145.b73c3808.js"><link rel="prefetch" href="/interview/assets/js/146.f1c5e8bc.js"><link rel="prefetch" href="/interview/assets/js/147.b2f440d7.js"><link rel="prefetch" href="/interview/assets/js/148.c423d578.js"><link rel="prefetch" href="/interview/assets/js/149.f9eaf94e.js"><link rel="prefetch" href="/interview/assets/js/15.7ff4b8c0.js"><link rel="prefetch" href="/interview/assets/js/150.b0009933.js"><link rel="prefetch" href="/interview/assets/js/151.f4e18cb5.js"><link rel="prefetch" href="/interview/assets/js/152.82d6762e.js"><link rel="prefetch" href="/interview/assets/js/153.0d8f7530.js"><link rel="prefetch" href="/interview/assets/js/154.81c45947.js"><link rel="prefetch" href="/interview/assets/js/155.a8cab9bc.js"><link rel="prefetch" href="/interview/assets/js/156.1d4acc99.js"><link rel="prefetch" href="/interview/assets/js/157.e1354fee.js"><link rel="prefetch" href="/interview/assets/js/158.eb7bec25.js"><link rel="prefetch" href="/interview/assets/js/159.7e0b00ba.js"><link rel="prefetch" href="/interview/assets/js/16.2a952e5b.js"><link rel="prefetch" href="/interview/assets/js/160.56b20925.js"><link rel="prefetch" href="/interview/assets/js/161.f972b416.js"><link rel="prefetch" href="/interview/assets/js/162.e5893334.js"><link rel="prefetch" href="/interview/assets/js/163.0d84751b.js"><link rel="prefetch" href="/interview/assets/js/164.7b5151cc.js"><link rel="prefetch" href="/interview/assets/js/165.0aae88d9.js"><link rel="prefetch" href="/interview/assets/js/166.0aac4e24.js"><link rel="prefetch" href="/interview/assets/js/167.739e7288.js"><link rel="prefetch" href="/interview/assets/js/168.253645c9.js"><link rel="prefetch" href="/interview/assets/js/169.76df226e.js"><link rel="prefetch" href="/interview/assets/js/17.1ff956b1.js"><link rel="prefetch" href="/interview/assets/js/170.402e31d3.js"><link rel="prefetch" href="/interview/assets/js/171.18f7b6d2.js"><link rel="prefetch" href="/interview/assets/js/172.a458c983.js"><link rel="prefetch" href="/interview/assets/js/173.3b16da5e.js"><link rel="prefetch" href="/interview/assets/js/174.69027959.js"><link rel="prefetch" href="/interview/assets/js/175.db48c27c.js"><link rel="prefetch" href="/interview/assets/js/176.7e8c95e5.js"><link rel="prefetch" href="/interview/assets/js/177.cf3441f0.js"><link rel="prefetch" href="/interview/assets/js/178.5655816a.js"><link rel="prefetch" href="/interview/assets/js/179.6987ac3c.js"><link rel="prefetch" href="/interview/assets/js/18.3256f17f.js"><link rel="prefetch" href="/interview/assets/js/180.0188a17f.js"><link rel="prefetch" href="/interview/assets/js/181.519a59ff.js"><link rel="prefetch" href="/interview/assets/js/182.242b3133.js"><link rel="prefetch" href="/interview/assets/js/183.54a5f8f9.js"><link rel="prefetch" href="/interview/assets/js/184.af4f25c1.js"><link rel="prefetch" href="/interview/assets/js/185.b61697a6.js"><link rel="prefetch" href="/interview/assets/js/19.7080e96a.js"><link rel="prefetch" href="/interview/assets/js/20.2760311a.js"><link rel="prefetch" href="/interview/assets/js/21.dfe42584.js"><link rel="prefetch" href="/interview/assets/js/22.60c145d0.js"><link rel="prefetch" href="/interview/assets/js/23.fc9a257f.js"><link rel="prefetch" href="/interview/assets/js/24.20a61536.js"><link rel="prefetch" href="/interview/assets/js/25.c0eba41b.js"><link rel="prefetch" href="/interview/assets/js/26.7b2b25d6.js"><link rel="prefetch" href="/interview/assets/js/27.e1a6c9b6.js"><link rel="prefetch" href="/interview/assets/js/28.8964c19b.js"><link rel="prefetch" href="/interview/assets/js/29.a34ad823.js"><link rel="prefetch" href="/interview/assets/js/3.1061a9b3.js"><link rel="prefetch" href="/interview/assets/js/30.0b5cf75e.js"><link rel="prefetch" href="/interview/assets/js/31.b28448e8.js"><link rel="prefetch" href="/interview/assets/js/32.9f701dce.js"><link rel="prefetch" href="/interview/assets/js/33.6a78d427.js"><link rel="prefetch" href="/interview/assets/js/34.a6d9e550.js"><link rel="prefetch" href="/interview/assets/js/35.badc65fc.js"><link rel="prefetch" href="/interview/assets/js/36.7dbd87e9.js"><link rel="prefetch" href="/interview/assets/js/37.59707494.js"><link rel="prefetch" href="/interview/assets/js/38.7bb0385f.js"><link rel="prefetch" href="/interview/assets/js/39.77322fe1.js"><link rel="prefetch" href="/interview/assets/js/4.45665f8a.js"><link rel="prefetch" href="/interview/assets/js/40.8ee4d5a8.js"><link rel="prefetch" href="/interview/assets/js/41.97ae5640.js"><link rel="prefetch" href="/interview/assets/js/42.099bead5.js"><link rel="prefetch" href="/interview/assets/js/43.beb377b7.js"><link rel="prefetch" href="/interview/assets/js/44.f7b4b3eb.js"><link rel="prefetch" href="/interview/assets/js/45.e61b91da.js"><link rel="prefetch" href="/interview/assets/js/46.f4aa556f.js"><link rel="prefetch" href="/interview/assets/js/47.a8a00282.js"><link rel="prefetch" href="/interview/assets/js/48.dd920a37.js"><link rel="prefetch" href="/interview/assets/js/49.f9ad33fd.js"><link rel="prefetch" href="/interview/assets/js/5.80ca5834.js"><link rel="prefetch" href="/interview/assets/js/50.3798932f.js"><link rel="prefetch" href="/interview/assets/js/51.9d9f4431.js"><link rel="prefetch" href="/interview/assets/js/52.880a7e32.js"><link rel="prefetch" href="/interview/assets/js/53.41f40714.js"><link rel="prefetch" href="/interview/assets/js/54.d4a82f40.js"><link rel="prefetch" href="/interview/assets/js/55.499d0a8c.js"><link rel="prefetch" href="/interview/assets/js/56.ca6ab39b.js"><link rel="prefetch" href="/interview/assets/js/57.6adfe0d5.js"><link rel="prefetch" href="/interview/assets/js/58.bf6c416f.js"><link rel="prefetch" href="/interview/assets/js/59.b5795831.js"><link rel="prefetch" href="/interview/assets/js/6.b28845f9.js"><link rel="prefetch" href="/interview/assets/js/60.612c2c95.js"><link rel="prefetch" href="/interview/assets/js/61.26030a28.js"><link rel="prefetch" href="/interview/assets/js/62.d4de59db.js"><link rel="prefetch" href="/interview/assets/js/63.c5deba62.js"><link rel="prefetch" href="/interview/assets/js/64.133c8a96.js"><link rel="prefetch" href="/interview/assets/js/65.b047e2fe.js"><link rel="prefetch" href="/interview/assets/js/66.86f26afd.js"><link rel="prefetch" href="/interview/assets/js/67.355c019e.js"><link rel="prefetch" href="/interview/assets/js/68.738ce098.js"><link rel="prefetch" href="/interview/assets/js/69.4c9c4530.js"><link rel="prefetch" href="/interview/assets/js/7.ff4b35fb.js"><link rel="prefetch" href="/interview/assets/js/70.61f108a6.js"><link rel="prefetch" href="/interview/assets/js/71.105a14fb.js"><link rel="prefetch" href="/interview/assets/js/72.d86ee653.js"><link rel="prefetch" href="/interview/assets/js/73.c8b8cedc.js"><link rel="prefetch" href="/interview/assets/js/74.ebc3f37e.js"><link rel="prefetch" href="/interview/assets/js/75.cc3ecbc5.js"><link rel="prefetch" href="/interview/assets/js/76.063a7a59.js"><link rel="prefetch" href="/interview/assets/js/77.e9bbf03a.js"><link rel="prefetch" href="/interview/assets/js/78.ffa399c3.js"><link rel="prefetch" href="/interview/assets/js/79.6644c726.js"><link rel="prefetch" href="/interview/assets/js/80.210c74f8.js"><link rel="prefetch" href="/interview/assets/js/81.db2c1499.js"><link rel="prefetch" href="/interview/assets/js/82.7fdbe7b3.js"><link rel="prefetch" href="/interview/assets/js/83.22452753.js"><link rel="prefetch" href="/interview/assets/js/84.2eaf53a5.js"><link rel="prefetch" href="/interview/assets/js/85.643bd267.js"><link rel="prefetch" href="/interview/assets/js/86.8610be96.js"><link rel="prefetch" href="/interview/assets/js/87.d3b76b81.js"><link rel="prefetch" href="/interview/assets/js/88.236b4504.js"><link rel="prefetch" href="/interview/assets/js/89.fe25dc7f.js"><link rel="prefetch" href="/interview/assets/js/90.a8aca676.js"><link rel="prefetch" href="/interview/assets/js/92.c6780432.js"><link rel="prefetch" href="/interview/assets/js/93.6759903b.js"><link rel="prefetch" href="/interview/assets/js/94.33715ab0.js"><link rel="prefetch" href="/interview/assets/js/95.50fbc3e8.js"><link rel="prefetch" href="/interview/assets/js/96.f44f883c.js"><link rel="prefetch" href="/interview/assets/js/97.ebf2a9dd.js"><link rel="prefetch" href="/interview/assets/js/98.c03c1ef8.js"><link rel="prefetch" href="/interview/assets/js/99.2939fb4a.js"><link rel="prefetch" href="/interview/assets/js/vendors~docsearch.77260563.js">
    <link rel="stylesheet" href="/interview/assets/css/0.styles.e79fd175.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/interview/" class="home-link router-link-active"><img src="/interview/assets/img/jinx.png" alt="" class="logo"> <!----></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="操作系统" class="dropdown-title"><span class="title">操作系统</span> <span class="arrow down"></span></button> <button type="button" aria-label="操作系统" class="mobile-dropdown-title"><span class="title">操作系统</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/os/1_hardware/" class="nav-link">
  硬件系统
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/2_os_structure/" class="nav-link">
  操作系统结构
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/3_memory/" class="nav-link">
  内存管理
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/4_process/" class="nav-link">
  进程管理
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/5_schedule/" class="nav-link">
  调度算法
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/6_file_system/" class="nav-link">
  文件系统
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/7_device/" class="nav-link">
  设备管理
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/8_network_system/" class="nav-link">
  网络系统
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/9_linux_cmd/" class="nav-link">
  Linux命令
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/10_learn/" class="nav-link">
  学习心得
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="网络" class="dropdown-title"><span class="title">网络</span> <span class="arrow down"></span></button> <button type="button" aria-label="网络" class="mobile-dropdown-title"><span class="title">网络</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/network/1_base/" class="nav-link">
  基础篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/network/2_http/" class="nav-link">
  HTTP篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/network/3_tcp/" class="nav-link router-link-active">
  TCP篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/network/4_ip/" class="nav-link">
  IP篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/network/5_learn/" class="nav-link">
  学习心得
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/mysql/base/" class="nav-link">
  基础篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/mysql/index/" class="nav-link">
  索引篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/mysql/transaction/" class="nav-link">
  事务篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/mysql/lock/" class="nav-link">
  锁篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/mysql/log/" class="nav-link">
  日志篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/mysql/buffer_pool/" class="nav-link">
  内存篇
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="redis" class="dropdown-title"><span class="title">redis</span> <span class="arrow down"></span></button> <button type="button" aria-label="redis" class="mobile-dropdown-title"><span class="title">redis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/redis/base/" class="nav-link">
  面试
</a></li><li class="dropdown-item"><!----> <a href="/interview/redis/data_struct/" class="nav-link">
  数据类型
</a></li><li class="dropdown-item"><!----> <a href="/interview/redis/storage/" class="nav-link">
  持久化
</a></li><li class="dropdown-item"><!----> <a href="/interview/redis/module/" class="nav-link">
  功能篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/redis/cluster/" class="nav-link">
  高可用
</a></li><li class="dropdown-item"><!----> <a href="/interview/redis/architecture/" class="nav-link">
  缓存
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java学习" class="dropdown-title"><span class="title">Java学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java学习" class="mobile-dropdown-title"><span class="title">Java学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/JavaLearning/Java基础/" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/interview/JavaLearning/Spring/" class="nav-link">
  Java进阶
</a></li></ul></div></div> <a href="https://github.com/Code-suphub/interview" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="操作系统" class="dropdown-title"><span class="title">操作系统</span> <span class="arrow down"></span></button> <button type="button" aria-label="操作系统" class="mobile-dropdown-title"><span class="title">操作系统</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/os/1_hardware/" class="nav-link">
  硬件系统
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/2_os_structure/" class="nav-link">
  操作系统结构
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/3_memory/" class="nav-link">
  内存管理
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/4_process/" class="nav-link">
  进程管理
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/5_schedule/" class="nav-link">
  调度算法
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/6_file_system/" class="nav-link">
  文件系统
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/7_device/" class="nav-link">
  设备管理
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/8_network_system/" class="nav-link">
  网络系统
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/9_linux_cmd/" class="nav-link">
  Linux命令
</a></li><li class="dropdown-item"><!----> <a href="/interview/os/10_learn/" class="nav-link">
  学习心得
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="网络" class="dropdown-title"><span class="title">网络</span> <span class="arrow down"></span></button> <button type="button" aria-label="网络" class="mobile-dropdown-title"><span class="title">网络</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/network/1_base/" class="nav-link">
  基础篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/network/2_http/" class="nav-link">
  HTTP篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/network/3_tcp/" class="nav-link router-link-active">
  TCP篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/network/4_ip/" class="nav-link">
  IP篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/network/5_learn/" class="nav-link">
  学习心得
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow down"></span></button> <button type="button" aria-label="数据库" class="mobile-dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/mysql/base/" class="nav-link">
  基础篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/mysql/index/" class="nav-link">
  索引篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/mysql/transaction/" class="nav-link">
  事务篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/mysql/lock/" class="nav-link">
  锁篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/mysql/log/" class="nav-link">
  日志篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/mysql/buffer_pool/" class="nav-link">
  内存篇
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="redis" class="dropdown-title"><span class="title">redis</span> <span class="arrow down"></span></button> <button type="button" aria-label="redis" class="mobile-dropdown-title"><span class="title">redis</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/redis/base/" class="nav-link">
  面试
</a></li><li class="dropdown-item"><!----> <a href="/interview/redis/data_struct/" class="nav-link">
  数据类型
</a></li><li class="dropdown-item"><!----> <a href="/interview/redis/storage/" class="nav-link">
  持久化
</a></li><li class="dropdown-item"><!----> <a href="/interview/redis/module/" class="nav-link">
  功能篇
</a></li><li class="dropdown-item"><!----> <a href="/interview/redis/cluster/" class="nav-link">
  高可用
</a></li><li class="dropdown-item"><!----> <a href="/interview/redis/architecture/" class="nav-link">
  缓存
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java学习" class="dropdown-title"><span class="title">Java学习</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java学习" class="mobile-dropdown-title"><span class="title">Java学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/interview/JavaLearning/Java基础/" class="nav-link">
  Java基础
</a></li><li class="dropdown-item"><!----> <a href="/interview/JavaLearning/Spring/" class="nav-link">
  Java进阶
</a></li></ul></div></div> <a href="https://github.com/Code-suphub/interview" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>3 Tcp</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/interview/network/3_tcp/" aria-current="page" class="sidebar-link">nothing</a></li><li><a href="/interview/network/3_tcp/challenge_ack.html" class="sidebar-link">4.9 已建立连接的 TCP，收到 SYN 会发生什么？</a></li><li><a href="/interview/network/3_tcp/isn_deff.html" class="sidebar-link">4.7 为什么 TCP 每次建立连接时，初始化序列号都要不一样呢？</a></li><li><a href="/interview/network/3_tcp/out_of_order_fin.html" class="sidebar-link">4.10 四次挥手中收到乱序的 FIN 包会如何处理？</a></li><li><a href="/interview/network/3_tcp/port.html" class="sidebar-link">4.18 TCP 和 UDP 可以使用同一个端口吗？</a></li><li><a href="/interview/network/3_tcp/quic.html" class="sidebar-link">4.17 如何基于 UDP 协议实现可靠传输？</a></li><li><a href="/interview/network/3_tcp/syn_drop.html" class="sidebar-link">4.8 SYN 报文什么时候情况下会被丢弃？</a></li><li><a href="/interview/network/3_tcp/tcp_down_and_crash.html" class="sidebar-link">4.12 TCP 连接，一端断电和进程崩溃有什么区别？</a></li><li><a href="/interview/network/3_tcp/tcp_drop.html" aria-current="page" class="active sidebar-link">4.21 用了 TCP 协议，数据一定不会丢吗？</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/interview/network/3_tcp/tcp_drop.html#数据包的发送流程" class="sidebar-link">数据包的发送流程</a></li><li class="sidebar-sub-header"><a href="/interview/network/3_tcp/tcp_drop.html#建立连接时丢包" class="sidebar-link">建立连接时丢包</a></li><li class="sidebar-sub-header"><a href="/interview/network/3_tcp/tcp_drop.html#流量控制丢包" class="sidebar-link">流量控制丢包</a></li><li class="sidebar-sub-header"><a href="/interview/network/3_tcp/tcp_drop.html#网卡丢包" class="sidebar-link">网卡丢包</a></li><li class="sidebar-sub-header"><a href="/interview/network/3_tcp/tcp_drop.html#接收缓冲区丢包" class="sidebar-link">接收缓冲区丢包</a></li><li class="sidebar-sub-header"><a href="/interview/network/3_tcp/tcp_drop.html#两端之间的网络丢包" class="sidebar-link">两端之间的网络丢包</a></li><li class="sidebar-sub-header"><a href="/interview/network/3_tcp/tcp_drop.html#发生丢包了怎么办" class="sidebar-link">发生丢包了怎么办</a></li><li class="sidebar-sub-header"><a href="/interview/network/3_tcp/tcp_drop.html#用了-tcp-协议就一定不会丢包吗" class="sidebar-link">用了 TCP 协议就一定不会丢包吗</a></li><li class="sidebar-sub-header"><a href="/interview/network/3_tcp/tcp_drop.html#这类丢包问题怎么解决" class="sidebar-link">这类丢包问题怎么解决？</a></li><li class="sidebar-sub-header"><a href="/interview/network/3_tcp/tcp_drop.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/interview/network/3_tcp/tcp_feature.html" class="sidebar-link">4.2 TCP 重传、滑动窗口、流量控制、拥塞控制</a></li><li><a href="/interview/network/3_tcp/tcp_http_keepalive.html" class="sidebar-link">4.15 TCP Keepalive 和 HTTP Keep-Alive 是一个东西吗？</a></li><li><a href="/interview/network/3_tcp/tcp_interview.html" class="sidebar-link">4.1 TCP 三次握手与四次挥手面试题</a></li><li><a href="/interview/network/3_tcp/tcp_no_accpet.html" class="sidebar-link">4.20 没有 accept，能建立 TCP 连接吗？</a></li><li><a href="/interview/network/3_tcp/tcp_no_listen.html" class="sidebar-link">4.19 服务端没有 listen，客户端发起连接建立，会发生什么？</a></li><li><a href="/interview/network/3_tcp/tcp_optimize.html" class="sidebar-link">4.5 如何优化 TCP?</a></li><li><a href="/interview/network/3_tcp/tcp_problem.html" class="sidebar-link">4.16 TCP 协议有什么缺陷？</a></li><li><a href="/interview/network/3_tcp/tcp_queue.html" class="sidebar-link">4.4 TCP 半连接队列和全连接队列</a></li><li><a href="/interview/network/3_tcp/tcp_stream.html" class="sidebar-link">4.6 如何理解是 TCP 面向字节流协议？</a></li><li><a href="/interview/network/3_tcp/tcp_tcpdump.html" class="sidebar-link">4.3 TCP 实战抓包分析</a></li><li><a href="/interview/network/3_tcp/tcp_three_fin.html" class="sidebar-link">4.22 TCP 四次挥手，可以变成三次吗？</a></li><li><a href="/interview/network/3_tcp/tcp_tls.html" class="sidebar-link">4.14 HTTPS 中 TLS 和 TCP 能同时握手吗？</a></li><li><a href="/interview/network/3_tcp/tcp_tw_reuse_close.html" class="sidebar-link">4.14 tcptwreuse 为什么默认是关闭的？</a></li><li><a href="/interview/network/3_tcp/tcp_unplug_the_network_cable.html" class="sidebar-link">4.13 拔掉网线后，原本的 TCP 连接还存在吗？</a></li><li><a href="/interview/network/3_tcp/time_wait_recv_syn.html" class="sidebar-link">4.11 在 TIME_WAIT 状态的 TCP 连接，收到 SYN 后会发生什么？</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_4-21-用了-tcp-协议-数据一定不会丢吗"><a href="#_4-21-用了-tcp-协议-数据一定不会丢吗" class="header-anchor">#</a> 4.21 用了 TCP 协议，数据一定不会丢吗？</h1> <blockquote><p>来源：公众号@小白 debug</p> <p>原文地址：<a href="https://mp.weixin.qq.com/s/XNJoaVnYT1SxHsdNWeAaUw" target="_blank" rel="noopener noreferrer">用了 TCP 协议，数据一定不会丢吗？<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p>大家后，我是小林。</p> <p>问大家一句：TCP 是一个可靠的传输协议，那它一定能保证数据不丢失吗？</p> <p>这次，就跟大家探讨这个问题。</p> <h2 id="数据包的发送流程"><a href="#数据包的发送流程" class="header-anchor">#</a> 数据包的发送流程</h2> <p>首先，我们两个手机的绿皮聊天软件客户端，要通信，中间会通过它们家服务器。大概长这样。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/1d0a1d60ca4f720423911cf8f25c4ac3.png" alt="聊天软件三端通信"></p> <p>但为了<strong>简化模型</strong>，我们把中间的服务器给省略掉，假设这是个端到端的通信。且为了保证消息的可靠性，我们盲猜它们之间用的是<strong>TCP 协议</strong>进行通信。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/7e8bae365b8d27560aac1cd28f501156.png" alt="聊天软件两端通信"></p> <p>为了发送数据包，两端首先会通过<strong>三次握手</strong>，建立 TCP 连接。</p> <p>一个数据包，从聊天框里发出，消息会从<strong>聊天软件</strong>所在的<strong>用户空间</strong>拷贝到<strong>内核空间</strong>的<strong>发送缓冲区（send buffer）</strong>，数据包就这样顺着<strong>传输层、网络层，进入到数据链路层，在这里数据包会经过流控（qdisc），再通过 RingBuffer 发到物理层的网卡</strong>。数据就这样顺着<strong>网卡</strong>发到了<strong>纷繁复杂</strong>的网络世界里。这里头数据会经过 n 多个<strong>路由器和交换机</strong>之间的跳转，最后到达<strong>目的机器的网卡</strong>处。</p> <p>此时目的机器的网卡会通知<strong>DMA</strong>将数据包信息放到<code>RingBuffer</code>中，再触发一个<strong>硬中断</strong>给<code>CPU</code>，<code>CPU</code>触发<strong>软中断</strong>让<code>ksoftirqd</code>去<code>RingBuffer</code>收包，于是一个数据包就这样顺着<strong>物理层，数据链路层，网络层，传输层</strong>，最后从内核空间拷贝到用户空间里的<strong>聊天软件</strong>里。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/28e4d6b004530fbf75fe346d181baa81.png" alt="网络发包收包全景图"></p> <blockquote><p>画了那么大一张图，只水了 200 字做解释，我多少是有些心痛的。</p></blockquote> <p>到这里，抛开一些细节，大家大概知道了一个数据包从<strong>发送到接收</strong>的宏观过程。</p> <p>可以看到，这上面全是密密麻麻的<strong>名词</strong>。</p> <p>整条链路下来，有不少地方可能会发生丢包。</p> <p>但为了不让大家<strong>保持蹲姿太久</strong>影响身体健康，我这边只重点讲下几个<strong>常见容易发生丢包的场景</strong>。</p> <h2 id="建立连接时丢包"><a href="#建立连接时丢包" class="header-anchor">#</a> 建立连接时丢包</h2> <p>TCP 协议会通过<strong>三次握手</strong>建立连接。大概长下面这样。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/923f5005edb536c0d07b096bbf2ca282.png" alt="TCP 三次握手"></p> <p>在服务端，第一次握手之后，会先建立个<strong>半连接</strong>，然后再发出第二次握手。这时候需要有个地方可以<strong>暂存</strong>这些半连接。这个地方就叫<strong>半连接队列</strong>。</p> <p>如果之后第三次握手来了，半连接就会升级为全连接，然后暂存到另外一个叫<strong>全连接队列</strong>的地方，坐等程序执行<code>accept()</code>方法将其取走使用。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/02a78bb83fe167324f26e8c910d7a7a2.png" alt="半连接队列和全连接队列"></p> <p>是队列就有长度，有长度就有可能会满，如果它们<strong>满了</strong>，那新来的包就会被<strong>丢弃</strong>。</p> <p>可以通过下面的方式查看是否存在这种丢包行为。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 全连接队列溢出次数</span>
<span class="token comment"># netstat -s | grep overflowed</span>
    <span class="token number">4343</span> <span class="token builtin class-name">times</span> the listen queue of a socket overflowed

<span class="token comment"># 半连接队列溢出次数</span>
<span class="token comment"># netstat -s | grep -i &quot;SYNs to LISTEN sockets dropped&quot;</span>
    <span class="token number">109</span> <span class="token builtin class-name">times</span> the listen queue of a socket overflowed 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>从现象来看就是连接建立失败。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/591d630098b4fc5316a5005f1e94b844.png" alt="图片"></p> <h2 id="流量控制丢包"><a href="#流量控制丢包" class="header-anchor">#</a> 流量控制丢包</h2> <p>应用层能发网络数据包的软件有那么多，如果所有数据不加控制一股脑冲入到网卡，网卡会吃不消，那怎么办？让数据按一定的规则排个队依次处理，也就是所谓的<strong>qdisc</strong>(<strong>Q</strong>ueueing <strong>Disc</strong>iplines，排队规则)，这也是我们常说的<strong>流量控制</strong>机制。</p> <p>排队，得先有个队列，而队列有个<strong>长度</strong>。</p> <p>我们可以通过下面的<code>ifconfig</code>命令查看到，里面涉及到的<code>txqueuelen</code>后面的数字<code>1000</code>，其实就是流控队列的长度。</p> <p>当发送数据过快，流控队列长度<code>txqueuelen</code>又不够大时，就容易出现<strong>丢包</strong>现象。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/6f2821018be08a2f27561155e8085de4.png" alt="qdisc 丢包"></p> <p>可以通过下面的<code>ifconfig</code>命令，查看 TX 下的 dropped 字段，当它大于 0 时，则<strong>有可能</strong>是发生了流控丢包。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># ifconfig eth0</span>
eth0: <span class="token assign-left variable">flags</span><span class="token operator">=</span><span class="token number">416</span><span class="token operator"><span class="token file-descriptor important">3</span>&lt;</span>UP,BROADCAST,RUNNING,MULTICAST<span class="token operator">&gt;</span>  mtu <span class="token number">1500</span>
        inet <span class="token number">172.21</span>.66.69  netmask <span class="token number">255.255</span>.240.0  broadcast <span class="token number">172.21</span>.79.255
        inet6 fe80::216:3eff:fe25:269f  prefixlen <span class="token number">64</span>  scopeid 0x2<span class="token operator"><span class="token file-descriptor important">0</span>&lt;</span>link<span class="token operator">&gt;</span>
        ether 00:16:3e:25:26:9f  txqueuelen <span class="token number">1000</span>  <span class="token punctuation">(</span>Ethernet<span class="token punctuation">)</span>
        RX packets <span class="token number">6962682</span>  bytes <span class="token number">1119047079</span> <span class="token punctuation">(</span><span class="token number">1.0</span> GiB<span class="token punctuation">)</span>
        RX errors <span class="token number">0</span>  dropped <span class="token number">0</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
        TX packets <span class="token number">9688919</span>  bytes <span class="token number">2072511384</span> <span class="token punctuation">(</span><span class="token number">1.9</span> GiB<span class="token punctuation">)</span>
        TX errors <span class="token number">0</span>  dropped <span class="token number">0</span> overruns <span class="token number">0</span>  carrier <span class="token number">0</span>  collisions <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>当遇到这种情况时，我们可以尝试修改下流控队列的长度。比如像下面这样将 eth0 网卡的流控队列长度从 1000 提升为 1500.</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># ifconfig eth0 txqueuelen 1500</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="网卡丢包"><a href="#网卡丢包" class="header-anchor">#</a> 网卡丢包</h2> <p>网卡和它的驱动导致丢包的场景也比较常见，原因很多，比如<strong>网线质量差，接触不良</strong>。除此之外，我们来聊几个常见的场景。</p> <h3 id="ringbuffer-过小导致丢包"><a href="#ringbuffer-过小导致丢包" class="header-anchor">#</a> RingBuffer 过小导致丢包</h3> <p>上面提到，在接收数据时，会将数据暂存到<code>RingBuffer</code>接收缓冲区中，然后等着内核触发软中断慢慢收走。如果这个<strong>缓冲区过小</strong>，而这时候发送的数据又过快，就有可能发生溢出，此时也会产生<strong>丢包</strong>。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/8f3ed2d6c4e2e154849f1e661528fe89.png" alt="RingBuffer 满了导致丢包"></p> <p>我们可以通过下面的命令去查看是否发生过这样的事情。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># ifconfig</span>
eth0:  RX errors <span class="token number">0</span>  dropped <span class="token number">0</span>  overruns <span class="token number">0</span>  frame <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>查看上面的<code>overruns</code>指标，它记录了由于<code>RingBuffer</code>长度不足导致的溢出次数。</p> <p>当然，用<code>ethtool</code>命令也能查看。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># ethtool -S eth0|grep rx_queue_0_drops</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>但这里需要注意的是，因为一个网卡里是可以有<strong>多个 RingBuffer</strong>的，所以上面的<code>rx_queue_0_drops</code>里的 0 代表的是<strong>第 0 个 RingBuffer</strong>的丢包数，对于多队列的网卡，这个 0 还可以改成其他数字。但我的家庭条件不允许我看其他队列的丢包数，所以上面的命令对我来说是够用了。。。</p> <p>当发现有这类型丢包的时候，可以通过下面的命令查看当前网卡的配置。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment">#ethtool -g eth0</span>
Ring parameters <span class="token keyword">for</span> eth0:
Pre-set maximums:
RX:        <span class="token number">4096</span>
RX Mini:    <span class="token number">0</span>
RX Jumbo:    <span class="token number">0</span>
TX:        <span class="token number">4096</span>
Current hardware settings:
RX:        <span class="token number">1024</span>
RX Mini:    <span class="token number">0</span>
RX Jumbo:    <span class="token number">0</span>
TX:        <span class="token number">1024</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>上面的输出内容，含义是<strong>RingBuffer 最大支持 4096 的长度，但现在实际只用了 1024。</strong></p> <p>想要修改这个长度可以执行<code>ethtool -G eth1 rx 4096 tx 4096</code>将发送和接收 RingBuffer 的长度都改为 4096。</p> <p><strong>RingBuffer</strong>增大之后，可以减少因为容量小而导致的丢包情况。</p> <h3 id="网卡性能不足"><a href="#网卡性能不足" class="header-anchor">#</a> 网卡性能不足</h3> <p>网卡作为硬件，<strong>传输速度是有上限的</strong>。当网络传输速度过大，达到网卡上限时，就会发生丢包。这种情况一般常见于压测场景。</p> <p>我们可以通过<code>ethtool</code>加网卡名，获得当前网卡支持的最大速度。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># ethtool eth0</span>
Settings <span class="token keyword">for</span> eth0:
    Speed: 10000Mb/s
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>可以看到，我这边用的网卡能支持的最大传输速度<strong>speed=1000Mb/s</strong>。</p> <p>也就是俗称的千兆网卡，但注意这里的单位是<strong>Mb</strong>，这里的<strong>b 是指 bit，而不是 Byte。1Byte=8bit</strong>。所以 10000Mb/s 还要除以 8，也就是理论上网卡最大传输速度是<code>1000/8 = 125MB/s</code>。</p> <p>我们可以通过<code>sar命令</code>从网络接口层面来分析数据包的收发情况。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># sar -n DEV 1</span>
Linux <span class="token number">3.10</span>.0-1127.19.1.el7.x86_64      <span class="token number">2022</span>年07月27日     _x86_64_    <span class="token punctuation">(</span><span class="token number">1</span> CPU<span class="token punctuation">)</span>

08时35分39秒     IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s    rxcmp/s   txcmp/s  rxmcst/s
08时35分40秒      eth0      <span class="token number">6.06</span>      <span class="token number">4.04</span>      <span class="token number">0.35</span>    <span class="token number">121682.33</span>   <span class="token number">0.00</span>    <span class="token number">0.00</span>     <span class="token number">0.00</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>其中 <strong>txkB/s 是指当前每秒发送的字节（byte）总数，rxkB/s 是指每秒接收的字节（byte）总数</strong>。</p> <p>当两者加起来的值约等于<code>12~13w字节</code>的时候，也就对应大概<code>125MB/s</code>的传输速度。此时达到网卡性能极限，就会开始丢包。</p> <p>遇到这个问题，优先看下你的服务是不是真有这么大的<strong>真实流量</strong>，如果是的话可以考虑下拆分服务，或者就忍痛充钱升级下配置吧。</p> <h2 id="接收缓冲区丢包"><a href="#接收缓冲区丢包" class="header-anchor">#</a> 接收缓冲区丢包</h2> <p>我们一般使用<code>TCP socket</code>进行网络编程的时候，内核都会分配一个<strong>发送缓冲区</strong>和一个<strong>接收缓冲区</strong>。</p> <p>当我们想要发一个数据包，会在代码里执行<code>send(msg)</code>，这时候数据包并不是一把梭直接就走网卡飞出去的。而是将数据拷贝到内核<strong>发送缓冲区</strong>就完事<strong>返回</strong>了，至于<strong>什么时候发数据，发多少数据</strong>，这个后续由内核自己做决定。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/9cd22437777205662048c73cc5855add.png" alt="tcp_sendmsg 逻辑"></p> <p>而<strong>接收缓冲区</strong>作用也类似，从外部网络收到的数据包就暂存在这个地方，然后坐等用户空间的应用程序将数据包取走。</p> <p>这两个缓冲区是有大小限制的，可以通过下面的命令去查看。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># 查看接收缓冲区</span>
<span class="token comment"># sysctl net.ipv4.tcp_rmem</span>
net.ipv4.tcp_rmem <span class="token operator">=</span> <span class="token number">4096</span>    <span class="token number">87380</span>   <span class="token number">6291456</span>

<span class="token comment"># 查看发送缓冲区</span>
<span class="token comment"># sysctl net.ipv4.tcp_wmem</span>
net.ipv4.tcp_wmem <span class="token operator">=</span> <span class="token number">4096</span>    <span class="token number">16384</span>   <span class="token number">4194304</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>不管是接收缓冲区还是发送缓冲区，都能看到三个数值，分别对应缓冲区的<strong>最小值，默认值和最大值（min、default、max）。缓冲区会在 min 和 max 之间动态调整。</strong></p> <p><strong>那么问题来了，如果缓冲区设置过小会怎么样？</strong></p> <p>对于<strong>发送缓冲区</strong>，执行 send 的时候，如果是<strong>阻塞</strong>调用，那就会等，等到缓冲区有空位可以发数据。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/7312e536393463dcf0d57aeb07f28ed5.gif" alt="send 阻塞"></p> <p>如果是<strong>非阻塞</strong>调用，就会<strong>立刻返回</strong>一个 <code>EAGAIN</code> 错误信息，意思是  <code>Try again</code>。让应用程序下次再重试。这种情况下一般不会发生丢包。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/f378a299ca60c490ee5437e1143916c8.gif" alt="send 非阻塞"></p> <p>当接受缓冲区满了，事情就不一样了，它的 TCP 接收窗口会变为 0，也就是所谓的<strong>零窗口</strong>，并且会通过数据包里的<code>win=0</code>，告诉发送端，&quot;球球了，顶不住了，别发了&quot;。一般这种情况下，发送端就该停止发消息了，但如果这时候确实还有数据发来，就会发生<strong>丢包</strong>。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/2df66c2e1d9f1245813e8d1de7482e0c.png" alt="recv_buffer 丢包"></p> <p>我们可以通过下面的命令里的<code>TCPRcvQDrop</code>查看到有没有发生过这种丢包现象。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">cat</span> /proc/net/netstat
TcpExt: SyncookiesSent TCPRcvQDrop SyncookiesFailed
TcpExt: <span class="token number">0</span>              <span class="token number">157</span>              <span class="token number">60116</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>但是说个伤心的事情，我们一般也看不到这个<code>TCPRcvQDrop</code>，因为这个是<code>5.9版本</code>里引入的打点，而我们的服务器用的一般是<code>2.x~3.x</code>左右版本。你可以通过下面的命令查看下你用的是什么版本的 linux 内核。</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># cat /proc/version</span>
Linux version <span class="token number">3.10</span>.0-1127.19.1.el7.x86_64
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="两端之间的网络丢包"><a href="#两端之间的网络丢包" class="header-anchor">#</a> 两端之间的网络丢包</h2> <p>前面提到的是两端机器内部的网络丢包，除此之外，两端之间那么长的一条链路都属于外部网络，这中间有各种路由器和交换机还有光缆啥的，丢包也是很经常发生的。</p> <p>这些丢包行为发生在中间链路的某些个机器上，我们当然是没权限去登录这些机器。但我们可以通过一些命令观察整个链路的连通情况。</p> <h3 id="ping-命令查看丢包"><a href="#ping-命令查看丢包" class="header-anchor">#</a> <strong>ping 命令查看丢包</strong></h3> <p>比如我们知道目的地的域名是 <code>baidu.com</code>。想知道你的机器到 baidu 服务器之间，有没有产生丢包行为。可以使用 ping 命令。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/56bdca9995c0c2a343b2b73b67933b78.png" alt="ping 查看丢包"></p> <p>倒数第二行里有个<code>100% packet loss</code>，意思是丢包率 100%。</p> <p>但这样其实你只能知道<strong>你的机器和目的机器之间有没有丢包。</strong></p> <p><strong>那如果你想知道你和目的机器之间的这条链路，哪个节点丢包了，有没有办法呢？</strong></p> <p>有。</p> <h3 id="mtr-命令"><a href="#mtr-命令" class="header-anchor">#</a> <strong>mtr 命令</strong></h3> <p>mtr 命令可以查看到你的机器和目的机器之间的每个节点的丢包情况。</p> <p>像下面这样执行命令。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/4a2d8dbfb648bcced864fb653af9f036.png" alt="mtr_icmp"></p> <p>其中 -r 是指 report，以报告的形式打印结果。</p> <p>可以看到<code>Host</code>那一列，出现的都是链路中间每一跳的机器，<code>Loss</code>的那一列就是指这一跳对应的丢包率。</p> <p>需要注意的是，中间有一些是 host 是<code>???</code>，那个是因为<strong>mtr 默认用的是 ICMP 包</strong>，有些节点限制了<strong>ICMP 包</strong>，导致不能正常展示。</p> <p>我们可以在 mtr 命令里加个<code>-u</code>，也就是使用<strong>udp 包</strong>，就能看到部分？??对应的 IP。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/0650adc524ab7d82028dc83cfc9961e1.png" alt="mtr-udp"></p> <p>把<strong>ICMP 包和 UDP 包的结果</strong>拼在一起看，就是<strong>比较完整</strong>的链路图了。</p> <p>还有个小细节，<code>Loss</code>那一列，我们在 icmp 的场景下，关注<strong>最后一行</strong>，如果是 0%，那不管前面 loss 是 100% 还是 80% 都无所谓，那些都是<strong>节点限制</strong>导致的<strong>虚报</strong>。</p> <p>但如果<strong>最后一行是 20%，再往前几行都是 20% 左右</strong>，那说明丢包就是从最接近的那一行开始产生的，长时间是这样，那很可能这一跳出了点问题。如果是公司内网的话，你可以带着这条线索去找对应的网络同事。如果是外网的话，那耐心点等等吧，别人家的开发会比你更着急。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/7142a4e285024dc6aadea4255984c485.png" alt="图片"></p> <h2 id="发生丢包了怎么办"><a href="#发生丢包了怎么办" class="header-anchor">#</a> 发生丢包了怎么办</h2> <p>说了这么多。只是想告诉大家，<strong>丢包是很常见的，几乎不可避免的一件事情</strong>。</p> <p>但问题来了，发生丢包了怎么办？</p> <p>这个好办，用<strong>TCP 协议</strong>去做传输。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/b2225e071fec7cfb240aa295ed4037bf.png" alt="TCP 是什么"></p> <p>建立了 TCP 连接的两端，发送端在发出数据后会等待接收端回复<code>ack包</code>，<code>ack包</code>的目的是为了告诉对方自己确实收到了数据，但如果中间链路发生了丢包，那发送端会迟迟收不到确认 ack，于是就会进行<strong>重传</strong>。以此来保证每个数据包都确确实实到达了接收端。</p> <p>假设现在网断了，我们还用聊天软件发消息，聊天软件会使用 TCP 不断尝试重传数据，<strong>如果重传期间网络恢复了</strong>，那数据就能正常发过去。但如果多次重试直到超时都还是失败，这时候你将收获一个<strong>红色感叹号</strong>。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/c1460d52efe7c5e4d80c2f7160d5b126.png" alt="图片"></p> <p>这时候问题又来了。</p> <p>假设<strong>某绿皮聊天软件用的就是 TCP 协议。</strong></p> <p>在聊天的时候，发生丢包了，丢包了会<strong>重试</strong>，重试失败了还会出现<strong>红色感叹号。</strong></p> <p>于是乎，问题就变成了，<strong>用了 TCP 协议，就一定不会丢包吗？</strong></p> <h2 id="用了-tcp-协议就一定不会丢包吗"><a href="#用了-tcp-协议就一定不会丢包吗" class="header-anchor">#</a> 用了 TCP 协议就一定不会丢包吗</h2> <p>我们知道 TCP 位于<strong>传输层</strong>，在它的上面还有各种<strong>应用层协议</strong>，比如常见的 HTTP 或者各类 RPC 协议。</p> <p><img src="https://img-blog.csdnimg.cn/img_convert/c6794dd51c8780f12e4022fc964ebb0a.png" alt="四层网络协议"></p> <p>TCP 保证的可靠性，是<strong>传输层的可靠性</strong>。也就是说，<strong>TCP 只保证数据从 A 机器的传输层可靠地发到 B 机器的传输层。</strong></p> <p>至于数据到了接收端的传输层之后，能不能保证到应用层，TCP 并不管。</p> <p>假设现在，我们输入一条消息，从聊天框发出，走到<strong>传输层 TCP 协议的发送缓冲区</strong>，不管中间有没有丢包，最后通过重传都保证发到了对方的<strong>传输层 TCP 接收缓冲区</strong>，此时接收端回复了一个<code>ack</code>，发送端收到这个<code>ack</code>后就会将自己<strong>发送缓冲区</strong>里的消息给扔掉。到这里 TCP 的任务就结束了。</p> <p>TCP 任务是结束了，但聊天软件的任务没结束。</p> <p><strong>聊天软件还需要将数据从 TCP 的接收缓冲区里读出来，如果在读出来这一刻，手机由于内存不足或其他各种原因，导致软件崩溃闪退了。</strong></p> <p>发送端以为自己发的消息已经发给对方了，但接收端却并没有收到这条消息。</p> <p>于是乎，<strong>消息就丢了。</strong></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/9286ab84bcaa74576bc11c8e9322fee9.png" alt="使用 TCP 协议却发生丢包"></p> <p><strong>虽然概率很小，但它就是发生了</strong>。</p> <p>合情合理，逻辑自洽。</p> <h2 id="这类丢包问题怎么解决"><a href="#这类丢包问题怎么解决" class="header-anchor">#</a> 这类丢包问题怎么解决？</h2> <p>故事到这里也到尾声了，感动之余，我们来<strong>聊点掏心窝子的话</strong>。</p> <p><strong>其实前面说的都对，没有一句是假话</strong>。</p> <p>但某绿皮聊天软件这么成熟，怎么可能没考虑过这一点呢。</p> <p>大家应该还记得我们文章开头提到过，<strong>为了简单</strong>，就将服务器那一方给省略了，从三端通信变成了两端通信，所以才有了这个丢包问题。</p> <p><strong>现在我们重新将服务器加回来。</strong></p> <p><img src="https://img-blog.csdnimg.cn/img_convert/d53659df39d64db4780d2816bd8314d1.png" alt="聊天软件三端通信"></p> <p>大家有没有发现，有时候我们在手机里聊了一大堆内容，然后登录电脑版，它能将最近的聊天记录都同步到电脑版上。也就是说服务器<strong>可能</strong>记录了我们最近发过什么数据，假设<strong>每条消息都有个 id</strong>，服务器和聊天软件每次都拿<strong>最新消息的 id</strong>进行对比，就能知道两端消息是否一致，就像<strong>对账</strong>一样。</p> <p>对于<strong>发送方</strong>，只要定时跟服务端的内容对账一下，就知道哪条消息没发送成功，直接重发就好了。</p> <p>如果<strong>接收方</strong>的聊天软件崩溃了，重启后跟服务器稍微通信一下就知道少了哪条数据，同步上来就是了，所以也不存在上面提到的丢包情况。</p> <p>可以看出，<strong>TCP 只保证传输层的消息可靠性，并不保证应用层的消息可靠性。如果我们还想保证应用层的消息可靠性，就需要应用层自己去实现逻辑做保证。</strong></p> <p>那么问题叒来了，<strong>两端通信的时候也能对账，为什么还要引入第三端服务器？</strong></p> <p>主要有三个原因。</p> <ul><li>第一，如果是两端通信，你聊天软件里有<code>1000个</code>好友，你就得建立<code>1000个</code>连接。但如果引入服务端，你只需要跟服务器建立<code>1个</code>连接就够了，<strong>聊天软件消耗的资源越少，手机就越省电</strong>。</li> <li>第二，就是<strong>安全问题</strong>，如果还是两端通信，随便一个人找你对账一下，你就把聊天记录给同步过去了，这并不合适吧。如果对方别有用心，信息就泄露了。引入第三方服务端就可以很方便的做各种<strong>鉴权</strong>校验。</li> <li>第三，是<strong>软件版本问题</strong>。软件装到用户手机之后，软件更不更新就是由用户说了算了。如果还是两端通信，且两端的<strong>软件版本跨度太大</strong>，很容易产生各种兼容性问题，但引入第三端服务器，就可以强制部分过低版本升级，否则不能使用软件。但对于大部分兼容性问题，给服务端加兼容逻辑就好了，不需要强制用户更新软件。</li></ul> <p>所以看到这里大家应该明白了，我把服务端去掉，并不单纯是<strong>为了简单</strong>。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li>数据从发送端到接收端，链路很长，任何一个地方都可能发生丢包，几乎可以说丢包不可避免。</li> <li>平时没事也不用关注丢包，大部分时候 TCP 的重传机制保证了消息可靠性。</li> <li>当你发现服务异常的时候，比如接口延时很高，总是失败的时候，可以用 ping 或者 mtr 命令看下是不是中间链路发生了丢包。</li> <li>TCP 只保证传输层的消息可靠性，并不保证应用层的消息可靠性。如果我们还想保证应用层的消息可靠性，就需要应用层自己去实现逻辑做保证。</li></ul> <hr> <p><em><strong>哈喽，我是小林，就爱图解计算机基础，如果觉得文章对你有帮助，欢迎微信搜索「小林 coding」</strong></em></p> <p><img src="https://cdn.xiaolincoding.com/gh/xiaolincoder/ImageHost3@main/%E5%85%B6%E4%BB%96/%E5%85%AC%E4%BC%97%E5%8F%B7%E4%BB%8B%E7%BB%8D.png" alt="img"></p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/Code-suphub/interview/edit/master/network/3_tcp/tcp_drop.md" target="_blank" rel="noopener noreferrer">完善页面</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">最后一次更新:</span> <span class="time">5/30/2024, 10:37:51 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/interview/network/3_tcp/tcp_down_and_crash.html" class="prev">
        4.12 TCP 连接，一端断电和进程崩溃有什么区别？
      </a></span> <span class="next"><a href="/interview/network/3_tcp/tcp_feature.html">
        4.2 TCP 重传、滑动窗口、流量控制、拥塞控制
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/interview/assets/js/app.c813ac80.js" defer></script><script src="/interview/assets/js/2.181747c8.js" defer></script><script src="/interview/assets/js/1.1f95d45d.js" defer></script><script src="/interview/assets/js/91.82c6f04d.js" defer></script>
  </body>
</html>
